prompt --application/deployment/install/upgrade_eba_proj_stat_get_con_comp
begin
--   Manifest
--     INSTALL: UPGRADE-eba_proj_stat_get_con_comp
--   Manifest End
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2021.04.15'
,p_release=>'21.1.7'
,p_default_workspace_id=>9008156634332785
,p_default_application_id=>134
,p_default_id_offset=>172493832712964115
,p_default_owner=>'MISO'
);
wwv_flow_api.create_install_script(
 p_id=>wwv_flow_api.id(7431373606806980237)
,p_install_id=>wwv_flow_api.id(9012014618759672631)
,p_name=>'eba_proj_stat_get_con_comp'
,p_sequence=>870
,p_script_type=>'UPGRADE'
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'create or replace function eba_proj_stat_get_con_comp (',
'    p_project_id in number,',
'    p_format     in varchar2 default ''HTML'')',
'    return varchar2',
'    -- valid p_format values STRING, HTML, NUMBER',
'as',
'   l_project_score number := 0;',
'   l_max_value number := 0;',
'   l_closed varchar2(1);',
'   l_active varchar2(1);',
'   x number := 0;',
'   r varchar2(4000) := null;',
'begin',
'for c1 in (',
'with build_opts as (',
'    select build_option_name,',
'        build_option_status',
'    from apex_application_build_options',
'    where application_id = v(''APP_ID'')',
')',
'select',
'    sum(the_score) s,',
'    sum(max_value) m',
'from',
'    (',
'        select  ''Project has an owner'' metric,',
'            case when exists (select null',
'                              from eba_proj_user_ref rf,',
'                                  eba_proj_status_users u',
'                              where rf.project_id = p.id',
'                                  and rf.user_id = u.id',
'                                  and eba_proj_fw.is_edit_authorized( u.username, rf.project_id ) = ''Y''',
'                             )',
'                    then 20 else 0 end as the_score,',
'                20 max_value',
'        from eba_proj_status p where id = p_project_id',
'        union all ',
'        select  ''Project has a URL'' metric, ',
'                decode(url,null,0,10) the_score,',
'                10 max_value',
'        from eba_proj_status where id = p_project_id',
'        union all ',
'        select  ''Project has a goal'' metric, ',
'                decode(goal,null,0,20) the_score,',
'                20 max_value',
'        from eba_proj_status where id = p_project_id',
'        union all',
'        select  ''Project has a goal longer then 200 characters'' metric, ',
'                decode(goal,null,0,10) the_score,',
'                10 max_value',
'        from eba_proj_status where id = p_project_id and nvl(length(goal),0) >= 200',
'        union all ',
'        select  ''Project has description longer then 200 characters'' metric, ',
'                decode(description,null,0,10) the_score,',
'                10 max_value ',
'        from eba_proj_status where id = p_project_id and nvl(length(description),0) >= 200',
'        union all ',
'        select  ''Project has tags'' metric, ',
'                decode(s.tags,null,0,10) the_score,',
'                10 max_value ',
'        from eba_proj_status s where id = p_project_id',
'        union all ',
'        select  ''Project has description'' metric, ',
'                decode(description,null,0,20) the_score,',
'                20 max_value ',
'        from eba_proj_status where id = p_project_id',
'        union all',
'        select  nvl(max(''Project has milestones''),''Project has milestones'') metric, ',
'                decode(count(*),0,0,20) the_score,',
'                nvl(max(20),20) max_value ',
'        from EBA_PROJ_STATUS_MS m,',
'            build_opts bo',
'        where  m.project_id = p_project_id ',
'            and bo.build_option_name = ''Project Milestones''',
'            and bo.build_option_status = ''Include''',
'        union all',
'        select  nvl(max(''Project has milestones past due (deduction)''),''Project has milestones past due (deduction)'') metric, ',
'                decode(count(*),0,0,-50) the_score,',
'                nvl(max(0),0) max_value ',
'        from EBA_PROJ_STATUS_MS m,',
'            build_opts bo',
'        where  m.project_id = p_project_id and m.milestone_status = ''Open'' and milestone_date < current_date',
'            and bo.build_option_name = ''Project Milestones''',
'            and bo.build_option_status = ''Include''',
'        union all',
'        select  nvl(max(''Project has links''),''Project has links'') metric, ',
'                decode(count(*),0,0,10) the_score,',
'                nvl(max(10),10) max_value ',
'        from EBA_PROJ_STATUS_LINKS l,',
'            build_opts bo',
'        where l.project_id = p_project_id ',
'            and bo.build_option_name = ''Project Links''',
'            and bo.build_option_status = ''Include''',
'        union all',
'        select  nvl(max(''Project has issues''),''Project has issues'') metric, ',
'                decode(count(*),0,0,10) the_score,',
'                nvl(max(10),10) max_value ',
'        from EBA_PROJ_STATUS_ISSUES i,',
'            build_opts bo',
'        where i.project_id = p_project_id ',
'            and bo.build_option_name = ''Project Issues''',
'            and bo.build_option_status = ''Include''',
'        union all',
'        select  nvl(max(''Project has resources''),''Project has resources'') metric, ',
'                decode(count(*),0,0,10) the_score,',
'                nvl(max(10),10) max_value ',
'        from EBA_PROJ_RESOURCES r,',
'            build_opts bo',
'        where r.project_id = p_project_id ',
'            and bo.build_option_name = ''Project Resources''',
'            and bo.build_option_status = ''Include''',
'        union all',
'        select  nvl(max(''Project has action items''),''Project has action items'') metric, ',
'                decode(count(*),0,0,20) the_score,',
'                nvl(max(20),20) max_value ',
'        from EBA_PROJ_STATUS_AIS a,',
'            build_opts bo',
'        where a.project_id = p_project_id',
'            and bo.build_option_name = ''Project Action Items''',
'        union all',
'        select  nvl(max(''Project has action items past due (deduction)''),''Project has action items pastdue (deduction)'') metric, ',
'                decode(count(*),0,0,-50) the_score,',
'                nvl(max(0),0) max_value ',
'        from EBA_PROJ_STATUS_AIS a,',
'            build_opts bo',
'        where a.project_id = p_project_id',
'            and action_status = ''Open''',
'            and due_date < current_date',
'            and bo.build_option_name = ''Project Action Items''',
'        union all',
'        select  nvl(max(''Project has project updates''),''Project has project updates'') metric, ',
'                decode(count(*),0,0,10) the_score,',
'                nvl(max(10),10) max_value ',
'        from eba_proj_status_updates u,',
'            build_opts bo',
'        where  u.project_id = p_project_id ',
'            and bo.build_option_name = ''Project Updates''',
'        union all',
'        select  nvl(max(''Project has project updates in last week''),''Project has project updates in last week'') metric, ',
'                decode(count(*),0,0,10) the_score,',
'                nvl(max(10),10) max_value ',
'        from EBA_PROJ_STATUS_UPDATES u,',
'            build_opts bo',
'        where  u.project_id = p_project_id  and UPDATE_DATE > (sysdate - 7)',
'            and bo.build_option_name = ''Project Updates''',
'        union all',
'        select  nvl(max(''Project has attachments''),''Project has attachments'') metric, ',
'                decode(count(*),0,0,5) the_score,',
'                nvl(max(5),5) max_value ',
'        from EBA_PROJ_STATUS_FILES u,',
'            build_opts bo',
'        where  u.project_id = p_project_id ',
'            and bo.build_option_name = ''Project Attachments''',
'        union all',
'        select  nvl(max(''Project has status reports''),''Project has status reports'') metric, ',
'                decode(count(*),0,0,10) the_score,',
'                nvl(max(10),10) max_value ',
'        from eba_proj_status_rpts u,',
'            build_opts bo',
'        where project_id = p_project_id',
'            and bo.build_option_name = ''Project Status Reports''',
'        union all',
'        select  nvl(max(''Project status is not desirable''),''Project statusis not desirable'') metric, ',
'                decode(count(*),0,0,-20) the_score,',
'                nvl(max(0),0) max_value ',
'        from eba_proj_status s , EBA_PROJ_STATUS_CODES c',
'        where s.id = p_project_id and s.PROJECT_STATUS = c.id and nvl(c.is_desirable_yn,''Y'') = ''N''',
'        union all',
'        select  nvl(max(''Project has been validated''),''Project has been validated'') metric, ',
'                decode(max((',
'                    select count(*)',
'                    from eba_proj_status_verifications v',
'                    where v.project_id = p_project_id )),0,0,20) the_score,',
'                nvl(max(20),20) max_value ',
'        from eba_proj_status,',
'            build_opts bo',
'        where id = p_project_id',
'            and bo.build_option_name = ''Project Validations''',
'        union all',
'        select  nvl(max(''Project has been validated in last week''),''Project has been validated in last week'') metric, ',
'                decode(max((',
'                    select count(*)',
'                    from eba_proj_status_verifications v',
'                    where v.project_id = p_project_id',
'                        and v.created > (sysdate - 7))),0,0,30) the_score,',
'                nvl(max(30),30) max_value ',
'        from eba_proj_status,',
'            build_opts bo',
'        where id = p_project_id',
'            and bo.build_option_name = ''Project Validations''',
'        union all',
'        select ''Project has been validated in last week by project owner'' metric, ',
'            case when exists (  select null',
'                                from eba_proj_user_ref rf,',
'                                    eba_proj_status_users u,',
'                                    eba_proj_status_verifications v',
'                                where rf.project_id = p.id',
'                                    and rf.user_id = u.id',
'                                    and eba_proj_fw.is_edit_authorized( u.username, rf.project_id ) = ''Y''',
'                                    and v.project_id = p.id',
'                                    and v.created > (sysdate-7)',
'                                    and upper(v.verified_by) = upper(u.username)',
'                             )',
'                then 30 else 0 end as the_score,',
'            30 max_value ',
'        from eba_proj_status p,',
'            build_opts bo',
'        where id = p_project_id',
'            and bo.build_option_name = ''Project Validations''',
'    ) x',
') loop',
'   l_project_score := c1.s;',
'   l_max_value := c1.m;',
'end loop;',
'   if NVL(l_project_score,0) > 0 and NVL(l_max_value,0) > 0 then',
'      x := round(100*(l_project_score/l_max_value));',
'   end if;',
'   if x > 100 then x := 100; end if;',
'   if x < 0 then x := 0; end if;',
'   if upper(trim(p_format)) = ''NUMBER'' then ',
'      return to_char(x);',
'   end if;',
'   for c1 in (select IS_CLOSED_STATUS, IS_ACTIVE_YN ',
'             from EBA_PROJ_STATUS_CODES ',
'             where id = (select max(PROJECT_STATUS) ',
'                         from EBA_PROJ_STATUS',
'                     where id = p_project_id)) loop',
'        l_closed := c1.IS_CLOSED_STATUS;',
'        l_active := c1.IS_ACTIVE_YN;',
'   end loop;',
'   if upper(trim(p_format)) = ''HTML'' then',
'       if NVL(l_closed,''0'') = ''Y'' then',
'          r :=  ''<span class="t-Badge t-Badge--basic t-Badge--small is-null w100p">N/A</span>'';',
'       elsif NVL(l_active,''0'') = ''N'' then',
'          r :=  ''<span class="t-Badge t-Badge--basic t-Badge--small is-null w100p">N/A</span>'';',
'       elsif x >= 95 then',
'          r :=  ''<span class="t-Badge t-Badge--basic t-Badge--small is-success w100p">Very Strong</span>'';',
'       elsif x >= 66 then ',
'          r :=  ''<span class="t-Badge t-Badge--basic t-Badge--small is-success w100p">Strong</span>'';',
'       elsif x >= 33 then',
'          r :=  ''<span class="t-Badge t-Badge--basic t-Badge--small is-warning w100p">Moderate</span>'';',
'       elsif x >= 1 then ',
'          r :=  ''<span class="t-Badge t-Badge--basic t-Badge--small is-danger w100p">Weak</span>'';',
'       else',
'          r :=  ''<span class="t-Badge t-Badge--basic t-Badge--small is-danger w100p">Very Weak</span>'';',
'       end if;',
'   else',
'       if NVL(l_closed,''0'') = ''Y'' then',
'          r :=  ''N/A'';',
'       elsif NVL(l_active,''0'') = ''N'' then',
'          r :=  ''N/A'';',
'       elsif x >= 95 then',
'          r :=  ''Very Strong'';',
'       elsif x >= 66 then ',
'          r :=  ''Strong'';',
'       elsif x >= 33 then',
'          r :=  ''Moderate'';',
'       elsif x >= 1 then ',
'          r :=  ''Weak'';',
'       else',
'          r :=  ''Very Weak'';',
'       end if;',
'   end if;',
'   return  r;',
'     ',
'end eba_proj_stat_get_con_comp;',
'/'))
);
wwv_flow_api.component_end;
end;
/
